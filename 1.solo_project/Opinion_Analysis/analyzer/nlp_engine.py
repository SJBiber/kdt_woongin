from soynlp.tokenizer import LTokenizer
import re
import logging
from .corrector import TyposCorrector

logger = logging.getLogger(__name__)

class NLPEngine:
    def __init__(self, use_corrector=True):
        # soynlp는 학습 기반이므로 간단한 키워드 추출을 위해 LTokenizer 사용
        self.tokenizer = LTokenizer()
        self.corrector = TyposCorrector() if use_corrector else None
        logger.info(f"NLPEngine initialized (use_corrector={use_corrector}).")

        # 포괄적 불용어 리스트 (유튜브 댓글 분석 최적화 - 중복 제거 및 대폭 확장)
        self.stopwords = set([
            # === 조사 ===
            '의','가','이','은','들','는','을','를','으로','로','에','에게','에서','부터','까지','만','도','나','이나','라도','마저','조차','과','와','하고','랑','이랑','이며','며',
            
            # === 어미 및 접미사 ===
            '고','지','며','거나','든지','던','었','았','겠','네요','어요','아요','해요','해','요','서','니','다','ㅂ니다','습니다','ㄴ다','ㄹ까','ㄴ가','ㄹ게','ㅂ시다',
            '네','죠','지요','나요','가요','군요','구나','구먼','ㄴ데','는데','ㄹ래','을래',
            
            # === 대명사 및 지시어 ===
            '저','나','너','우리','저희','여기','거기','저기','이것','그것','저것','뭐','누구','어디','언제','왜','어떻게','무엇','자','한','하나','둘','셋',
            '이','그','저','이런','저런','그런','이거','저거','그거','이런식으로','저런식으로','그런식으로',
            '저는','너는','그는','그녀는','우리는','저희는','이것은','그것은','저것은',
            '내가','네가','그가','그녀가','우리가','저희가','이것이','그것이','저것이','그것도',
            '내','네','제','당신','자기','본인','타인','남','다른','여러','각자','서로','누구나','아무나','모두','전부',
            
            # === 감탄사 및 추임새 (유튜브 특화) ===
            'ㅋㅋ','ㅋㅋㅋ','ㅎㅎ','ㅠㅠ','ㅜㅜ','ㄷㄷ','ㄹㅇ','ㅇㅈ','ㅇㅋ','ㅋ','ㄱ','ㅂ','ㅅ','ㅈ','ㅊ','ㅍ','ㅎ','ㅉㅉ','ㄴㄴ','ㅁㄴ','ㅇㅇ',
            '하','히','호','후','헉','엥','어','음','흠','아이고','어머','어머나','세상에','와','우와','오오','오','아','에','이','와우','허걱','헐','앗','응','네','예','흐음','어휴','아휴',
            '아이','어이','이런','저런','어머머','세상','맙소사','어쩜','어쩌면','어쩌다','어쩌나',
            
            # === 빈도 높은 동사/형용사 ===
            '있다','없다','되다','하다','이다','아니다','같다','보다','주다','받다','하는','되는','있는','없는','같은','보는','싶다','싶은','싶어',
            '알다','모르다','생각하다','느끼다','말하다','듣다','쓰다','읽다','오다','가다','나오다','들어가다','나가다','올라가다','내려가다',
            '없이','있는데','없는데','있어서','없어서','있는데도','없는데도','하면서','해라','나와','나오는','나온','원래','같은데','없나요','다시',
            '알았는데','몰랐는데','생각했는데','느꼈는데','말했는데','들었는데','썼는데','읽었는데','왔는데','갔는데',
            '하네','하네요','하더라','하더라고','하던데','하던데요','한다','한다고','한다는데','한다던데',
            '되네','되네요','되더라','되더라고','되던데','되던데요','된다','된다고','된다는데','된다던데',
            
            # === 유튜브 댓글 특화 ===
            '임성근','임짱','임','성근','장군','사단장','군인','군대','부대','해병대','해병','쉐프','셰프',
            '영상','댓글','유튜브','구독','좋아요','알림','설정','채널','보고','봤','봄','보니','보면','보는데','보니까','봐서','봐도','보세요','보시면','보셨나요',
            '올리다','올려','올린','올리는','올라온','올라와','올라왔','올라오','올라가','올라간','올려주세요','올려주시면',
            '클릭','링크','공유','저장','재생','시청','조회','추천','답글','대댓글',
            
            # === 부사 및 접속사 ===
            '진짜','너무','정말','진짜로','매우','완전','엄청','되게','좀','약간','조금','많이','더','덜','제일','가장','잘','걍','겁나','개','존나','졸라','무지','무척','아주','참','꽤','상당히','제법','몹시',
            '그냥','그','해서','그래','그래도','뭔가','대박','쩐다','짱','최고','굿','오케이','오키','오케','굳','쩔어','쩜','쩝','쩌','쩔','쩌는',
            '그리고','그러나','하지만','그래서','따라서','또','또한','역시','물론','당연히','확실히','분명히','절대','전혀','결코','오히려','차라리','아예','아무튼','어쨌든','어쨌거나',
            '근데','근데도','그럼에도','그럼','혹시','아니','이게','저게','뭐가','누가','하는데','하다가','하려고','하니까','해도','해봐도','해봤자',
            '막','살짝','슬쩍','확','딱','쫙','확실히','완전히','정말로','진심으로','솔직히','사실','실제로','정확히','명확히',
            '이렇게','저렇게','그렇게','이런식으로','저런식으로','그런식으로','때문에','원래는','원래부터','앞으로','앞으로도',
            '심지어','바로','이제','이제는','이제부터','아직','아직도','아직까지','벌써','이미','드디어','마침내','결국','끝내','마지막','처음','먼저','나중에',
            
            # === 시간 및 수량 표현 ===
            '오늘','어제','내일','지금','요즘','최근','예전','전','후','때','중','개','명','번','차','년','월','일','시','분','초','동안','만에','째',
            '넷','다섯','여섯','일곱','여덟','아홉','열','백','천','만','억','조','몇','얼마','전부','일부','일부분','대부분','거의',
            '언제나','항상','늘','자주','가끔','때때로','종종','이따금','드물게','한번','두번','세번','여러번','몇번','수차례',
            
            # === 기타 불필요 표현 ===
            '뭐','뭔','뭘','뭐가','뭐야','뭐지','뭐냐','뭐임','뭐예요','뭐죠','뭔데','뭔지','뭔가요','뭘까','뭐하는','뭐하냐','뭐하니','뭐하세요',
            '거','것','게','걸','건','겁','거나','거든','거야','거예요','거죠','건데','건지','건가요','거든요','거지','거잖아','거잖아요',
            '수','수가','수도','수는','수를','수에','수로','수만','수밖에','수있다','수없다','수있는','수없는',
            '것이','것을','것도','것만','것은','것에','것으로','것처럼','것같이','것같은','것같아','것같아요','것같네','것같네요',
            '되나요','되는데요','되는데','되는데도','되겠','되겠네','되겠어','되겠습니다','될까','될까요','될지','될지도','될듯','될것','될거',
            '하나요','하는데요','하는데도','하겠','하겠네','하겠어','하겠습니다','할까','할까요','할지','할지도','할듯','할것','할거',
            '있나요','있는데요','있겠','있겠네','있겠어','있겠습니다','있을까','있을까요','있을지','있을지도','있을듯','있을것','있을거',
            
            # === 접속 및 연결 표현 ===
            '그래서','그러니까','그러므로','그런데','그렇지만','그럼에도불구하고','그렇다면','그렇게','그렇게해서',
            '그리고나서','그다음','그후','그뒤','그리하여','이리하여','저리하여',
            '즉','다시말해','다시말하면','말하자면','요컨대','요약하면','정리하면','결론적으로',
            
            # === 의문 및 추측 표현 ===
            '뭐지','뭘까','뭔가','뭔데','뭔지','뭔가요','뭘까요','뭔데요','뭔지요',
            '그런가','그런가요','그런가봐','그런가보다','그런가봐요','그런가보네','그런가보네요',
            '그럴까','그럴까요','그럴까봐','그럴까보다','그럴까봐요','그럴까보네','그럴까보네요',
            '아닌가','아닌가요','아닌가봐','아닌가보다','아닌가봐요','아닌가보네','아닌가보네요',
            
            # === 강조 및 확인 표현 ===
            '정말','정말로','진짜','진짜로','참','참으로','과연','정녕','실로','진정','진정으로',
            '맞아','맞아요','맞네','맞네요','맞죠','맞지','맞지요','맞습니다','그렇죠','그렇지','그렇지요','그렇습니다',
            '당연','당연히','당연하지','당연하죠','당연하지요','물론이지','물론이죠','물론이지요',
        ])

    def preprocess(self, text):
        """텍스트 정제 및 맞춤법 교정 (단일)"""
        if not text:
            return ""
        
        # 1. 맞춤법 및 오타 교정 (먼저 수행하여 문맥 보존)
        if self.corrector:
            text = self.corrector.correct(text)
            
        # 2. 특수문자 제거
        clean_text = re.sub(r'[^가-힣0-9\s]', '', text)
        return clean_text

    def preprocess_batch(self, texts):
        """텍스트 정제 및 맞춤법 교정 (배치) - 성능 최적화"""
        if not texts:
            return []
        
        # 1. 맞춤법 및 오타 교정 (배치 처리)
        if self.corrector:
            corrected_texts = self.corrector.correct_batch(texts)
        else:
            corrected_texts = texts
            
        # 2. 특수문자 제거
        clean_texts = [re.sub(r'[^가-힣0-9\s]', '', text) for text in corrected_texts]
        return clean_texts

    def extract_keywords(self, text, min_length=2):
        """단어 추출 (LTokenizer 기반)"""
        if not text:
            return []
        
        try:
            # 텍스트에서 토큰 추출
            tokens = self.tokenizer.tokenize(text)
            # 불용어 제거 및 길이 제한
            keywords = [word for word in tokens if word not in self.stopwords and len(word) >= min_length]
            return list(set(keywords)) # 중복 제거
        except Exception as e:
            logger.error(f"Error during keyword extraction: {e}")
            return []

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    engine = NLPEngine()
    sample = "흑백요리사 너무 재밌어요! 출연자분들 요리 실력이 정말 대단하네요. 특히 인성이 좋은 것 같아요."
    clean = engine.preprocess(sample)
    keywords = engine.extract_keywords(clean)
    print(f"Original: {sample}")
    print(f"Keywords: {keywords}")
