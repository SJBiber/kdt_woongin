# 유튜브 크롤링 데이터 업데이트(Upsert) 로직 적용 계획

유튜브 영상의 통계 데이터(조회수, 좋아요 등)가 실시간으로 변동되므로, 기존 데이터를 단순히 삽입(Insert)하는 대신 이미 존재하는 데이터는 최신 통계로 업데이트(Update)하는 'Upsert' 로직을 확실히 적용합니다.

## 1. 현재 환경 확인 및 문제 인식
- **문제**: 기존 데이터가 존재하는 날짜의 경우, 단순히 삽입을 시도하면 에러가 발생하거나(Primary Key 위배) 중복 데이터가 쌓일 수 있음.
- **해결**: `ON CONFLICT` 구문을 사용하여 `(date, keyword)` 조합이 이미 DB에 있을 경우 기존 행의 통계 수치를 최신 값으로 덮어씌움.

## 2. 주요 수정 사항

### [1] `qoxjf135_database.py` (DB 로직)
- `insert_daily_trend` 함수 내 SQL 쿼리에 `ON CONFLICT (date, keyword) DO UPDATE` 로직이 완벽하게 작동하는지 확인하고 보완합니다.
- 데이터가 언제 마지막으로 업데이트되었는지 알 수 있도록 `last_updated_at` 컬럼(있을 경우)을 갱신하는 코드를 추가하거나, SQL 주석을 통해 로직을 명확히 합니다.

### [2] `qoxjf135_crawler.py` (크롤링 로직)
- 사용자의 요청대로 "시작 날짜는 프로젝트 고정일(2025-07-17), 종료 날짜는 오늘-1일"로 설정되어 전체 기간을 다시 훑으며 최신 통계를 가져오는지 확인합니다.
- 현재 코드의 주석과 변수명이 사용자의 의도와 일치하도록 다듬습니다.

## 3. 작업 단계
1. **`qoxjf135_database.py` 로직 점검**: Upsert 쿼리 확인 및 최적화.
2. **`qoxjf135_crawler.py` 날짜 로직 확인**: 사용자가 말한 "고정된 마지막 날짜(시작점)"와 "가변적인 시작 날짜(어제)" 관계를 코드로 명확히 구현.
3. **테스트 및 검증**: Airflow DAG에서 데이터가 정상적으로 업데이트되는지 시뮬레이션 확인.

## 4. 기대 결과
- 매일 DAG 실행 시, 과거 영상들의 변경된 조회수와 좋아요 수가 `daily_trends` 테이블에 최신 상태로 반영됨.
- 중복 데이터 발생 없이 데이터 무결성 유지.
